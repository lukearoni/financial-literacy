---
title: "Mathematical Model"
format: html
execute:
    echo: false
    warning: false
---

```{r}
# Load required libraries
library(tidyverse)
library(tidymodels)
library(broom)
library(gt)

# Step 1: Read CSV
df_raw <- read_csv("NFCSdata.csv")

df_raw <- df_raw |>
  mutate(
    # M6: Compound Interest (correct = 1 "More than $102")
    M6_correct = ifelse(M6 == 1, 1, 0),
    
    # M7: Inflation (correct = 3 "Less than today") 
    M7_correct = ifelse(M7 == 3, 1, 0),
    
    # M8: Bond Prices (correct = 2 "They will fall")
    M8_correct = ifelse(M8 == 2, 1, 0),
    
    # M9: Mortgage Terms (correct = 1 "True")
    M9_correct = ifelse(M9 == 1, 1, 0),
    
    # M10: Stock Diversification (correct = 2 "False")
    M10_correct = ifelse(M10 == 2, 1, 0),
    
    CreditCardBehavior = ifelse(F2_1 == 1, 1, 0)
)

# Step 2: Define column label mapping
column_labels <- c(
  A3Ar_w = "Age",
  A50A = "BinaryGender",
  A5_2015 = "Education",
  A8_2021 = "Income",
  M4 = "FinancialKnowledgeRating",
  M6_correct = "CompoundInterest",
  M7_correct = "Inflation",
  M8_correct = "BondPrices",
  M9_correct = "MortgageTerms",
  M10_correct = "StockDiversification",
  J5 = "EmergencyFund",
  CreditCardBehavior = "CreditCardBehavior"
)

df_clean <- df_raw |>
  filter(!if_any(everything(), ~ .x %in% c(98, 99, 999)))

# Step 3: Rename relevant columns and filter data
df <- df_clean |>
  rename_with(~ column_labels[.x], .cols = all_of(names(column_labels))) |>
  # Create composite financial literacy score
  mutate(fin_lit_score = CompoundInterest + Inflation + BondPrices + MortgageTerms + StockDiversification) |>
  # Drop missing values in any model-relevant columns
  drop_na(CreditCardBehavior, EmergencyFund, fin_lit_score, FinancialKnowledgeRating, Age, BinaryGender, Income, Education)
```


```{r}
#| cache: true
# IMPORTANT: Convert outcome variable to factor for classification
df$CreditCardBehavior <- factor(df$CreditCardBehavior, levels = c(0, 1), labels = c("No", "Yes"))

# Logistic regression model using glm engine
fit_lit <- logistic_reg(engine = "glm") |>
  fit(CreditCardBehavior ~ fin_lit_score, 
      data = df)

# View results
tidy(fit_lit)

# Make predictions (optional)
predictions <- fit_lit |>
  predict(df, type = "prob") |>
  bind_cols(df)

# View first few predictions
head(predictions)
```

## Table

```{r}
# Assume this is your model fit
tidy_fit <- tidy(fit_lit, conf.int = TRUE)

# Select and format only the desired columns
tidy_fit |>
  select(term, estimate, conf.low, conf.high) |>
  mutate(across(estimate:conf.high, ~ round(.x, 3))) |>
  mutate(term = recode(term,
                       "(Intercept)" = "Intercept",
                       "fin_lit_score" = "Financial Literacy Score")) |>
  gt() |>
  fmt_number(columns = estimate:conf.high, decimals = 3) |>
  cols_label(
    term = "Term",
    estimate = "Estimate",
    conf.low = "CI Lower",
    conf.high = "CI Upper"
  ) |>
  tab_header(
    title = "Model Estimates with Confidence Intervals"
  ) |>
  tab_source_note(
    source_note = "Source: NFCS 2021"
  ) |>
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    data_row.padding = px(4)
  )
```
